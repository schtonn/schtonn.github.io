<!DOCTYPE html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>schtonn</title>

    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/js/md5.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.loli.net/css2?family=Anonymous+Pro:ital,wght@0,400;0,700;1,400;1,700
&family=Noto+Serif+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script>
        var status, oid, user, pwd
        function getCookie(name) {
            let arr = document.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
            if (arr != null) return arr[2];
            return null;
        }
        function delCookie(name, path = 'u') {
            var exp = new Date();
            exp.setTime(exp.getTime() - 1);
            var cval = getCookie(name);
            if (cval != null)
                document.cookie = name + "=" + cval + ";expires=" + exp.toGMTString() + ((path == 'u') ? '' : ';path=' + path)
        }
        function getUrl(e) {
            return e.replace('dd.sdsz.com.cn', '43.143.233.184:81').replace('http:', 'https:').replace('.184/', '.184:81/')
        }
        function setStatus(e, fast) {
            status = e
            if (e == 1) {
                $('#loginSt').text('登录成功')
                $('#login').hide(200)
                $('#loginSt').addClass('label-success')
                $('#loginSt').removeClass('label-danger')
                $('.reqLogin').show(300)
                // $('#login').addClass('disable')
            } else if (e == 2) {
                $('#loginSt').text('登录失败')
                $('#loginSt').removeClass('label-success')
                $('#loginSt').addClass('label-danger')
            } else {
                $('#login').show()
                $('#loginSt').text('未登录')
                $('#loginSt').removeClass('label-success')
                $('#loginSt').removeClass('label-danger')
                $('.reqLogin').hide(300 * !fast)
                $('#avatar').attr('src', '')
                $('#user').text('-')
            }
        }
        function delCookies(force) {
            if (force) {
                delCookie('CASTGC', '/')
                delCookie('gosh', '/score/')
                delCookie('gosh', '/sso')
                delCookie('gowd', '/sso')
            }
            if (force == 2) {
                delCookie('JSESSIONID', '/bxn-portal')
                delCookie('JSESSIONID', '/bxn-library')
                delCookie('JSESSIONID', '/bxn-core-uic')
            }
            delCookie('JSESSIONID', '/')
            delCookie('JSESSIONID', '/sso')
            delCookie('JSESSIONID', '/sso/')
        }
        function postRes(){
            get('null', 'bxn-portal/portal/api/proxy?username=true&userId=true&needvalidate=true&t=http%3A%2F%2F202.94.10.118%2Fbxn-library%2Fapi%2Flibrary%2FgetLatestBorrowBook%3Fcategory%3D1&resourceId=103519&cache=nocache&systime=0')
            get('null', 'bxn-portal/portal/api/proxy?username=true&userId=true&needvalidate=true&t=http%3A%2F%2F202.94.10.164%3A18030%2Fbxn-office%2Fapi%2Fmsg%2FgetLatestActivities&resourceId=100022&cache=nocache&systime=0')
        }
        function postLogin() {
            if (status != 1) return;
            if (!user) user = getCookie('gosh'), pwd = getCookie('gowd')
            document.cookie = "gosh=" + user + ";path=/score/";
            document.cookie = "gosh=" + user + ";path=/sso";
            document.cookie = "gowd=" + pwd + ";path=/sso";
            $('#changePwd').val(pwd)
            get('null', 'bxn-library/library/jumpExamreport?jumpUrl=http://36.112.23.77/analysis/auto/%23/autoLogin')
        }
        function login() {
            if (status == 1) return;
            delCookies()
            console.log(document.cookie)
            user = $('#loginId').val(), pwd = $('#loginPwd').val()
            fetch("https://43.143.233.184:81/sso/login", {
                "headers": {
                    "content-type": "application/x-www-form-urlencoded; charset=UTF-8",
                    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36"
                },
                "method": "GET",
                "mode": "cors",
                "credentials": 'include'
            }).then(() => {
                return fetch('https://43.143.233.184/andlogin', {
                    method: 'POST',
                    headers: { 'Content-type': 'application/json' },
                    body: JSON.stringify({
                        user: user,
                        pwd: pwd,
                        cook: getCookie('JSESSIONID')
                    }),
                    credentials: 'include',
                })
            }).then(e => e.text()).then(e => {
                if (e == 'success') setStatus(1)
                else setStatus(2)
            }).then(postLogin)
        }
        function matches(e) {
            return e.match('n\\?username=') || e.match('requestParams') || e.match('newmessage')
        }
        function done(e) {
            if (e.match('requestParams')) {
                e = JSON.parse(e)
                $('#user').text(e.requestParams[0].ownerName)
                oid = e.requestParams[0].ownerId
                console.log(oid)
                $('#avatar').attr('src', 'https://43.143.233.184:81/avatar/tiny/' + oid)
            } else if (e.match('n\\?username')) {
                $('#scoreOld').attr('href', e)
            } else if (e.match('newmessage')) {

            }
        }
        function next(e) {//异步递归嘿嘿嘿，再多 302 也不怕
            if (e.length < 3000 && !matches(e)) {
                console.log(e)
                return fetch(getUrl(e), {
                    method: 'GET',
                    credentials: 'include'
                }).then(e => e.text()).then(next)
            }
            else return done(e), new Promise((resolve, reject) => { })
        }
        function get(name, url) {
            if (status != 1) return
            fetch('https://43.143.233.184:81/' + url, {
                method: 'GET',
                credentials: 'include'
            }).then(e => e.text()).then(next)
            $('#' + name).addClass('btn-success')
        }
        function change() {
            if (status != 1 || pwd == $('#changePwd').val()) return
            var fd = new URLSearchParams()
            fd.append('rating', '4')
            fd.append('ratingWord', '极佳')
            fd.append('oldPassword', pwd)
            fd.append('newPassword', $('#changePwd').val())
            fd.append('reNewPassword', $('#changePwd').val())
            fetch('https://43.143.233.184:81/bxn-core-uic/uic-public/personal/management/password/save', {
                "headers": {
                    "content-type": "application/x-www-form-urlencoded; charset=UTF-8",
                    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36"
                },
                method: 'POST',
                body: fd,
                credentials: 'include',
            })
            $('#changeBtn').addClass('btn-success')
        }
        $().ready(() => {
            $('.e').addClass('reqLogin disable')
            $('.e').removeClass('e')
            if (getCookie('CASTGC')) {
                setStatus(1), postLogin()
            } else setStatus(0, 1)
            $("[data-toggle='tooltip']").tooltip();
        })
    </script>
    <style>
        /* .disable {
            pointer-events: none;
            filter: contrast(90%) blur(2px)
        }

        .disable>btn {
            cursor: not-allowed;
            filter: alpha(opacity=65);
            -webkit-box-shadow: none;
            box-shadow: none;
            opacity: .65;
        } */

        .form-control {
            font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>

<body>
    <div class="page-header">
        <h2>数字校园</h2>
        <span id="loginSt" class="label label-default">未登录</span>
        <span id="user" class="label label-default">-</span>
        <button class="btn btn-danger btn-xs e" onclick="delCookies(1);setStatus(0)" onmouseenter="$('#double-off').css('scale','100%')" onmouseleave="$('#double-off').css('scale','0')">
            <span class="glyphicon glyphicon-log-out"></span>
        </button>
        <button id="double-off" class="btn btn-danger btn-xs e" onclick="delCookies(2);location.reload()" onmouseenter="$('#double-off').css('scale','100%')" onmouseleave="$('#double-off').css('scale','0')" style="scale:0;transition-duration: 1000ms;" data-toggle="tooltip" data-placement="right" title="全部重置">
            <span class="glyphicon glyphicon-off"></span>
        </button>
        <img id="avatar" style="position:absolute;right:10px;top:10px;">
    </div>
    <div class="col-md-4 col-sm-6 box">
        <div class="page-header">
            <h3><span class="glyphicon glyphicon-user"></span> 账号
                <div id="cookie" class="btn-group" style="display: none;">
                    <button id="bxn-portal" class="btn btn-default btn-xs" onclick="get('bxn-portal','bxn-portal/portal/osforstudent/index')">bxn-portal</button>
                    <button id="bxn-core-uic" class="btn btn-default btn-xs" onclick="get('bxn-core-uic','bxn-core-uic/uic/index')">bxn-core-uic</button>
                    <button id="bxn-library" class="btn btn-default btn-xs" onclick="get('bxn-library','bxn-library/library/jumpExamreport?jumpUrl=')">bxn-library</button>
                </div>
            </h3>
        </div>
        <button class="btn btn-default e" onclick="$('#change').toggle(200)">修改密码</button>
        <button class="btn btn-default e" onclick="$('#cookie').toggle(200);getCookies()">cookie</button>
        <div id="login">
            <br>
            <div class="input-group">
                <span class="input-group-addon">账号</span>
                <input id="loginId" type="id" class="form-control" placeholder="20222222" value="20222446">
            </div>
            <br>
            <div class="input-group">
                <span class="input-group-addon">密码</span>
                <input id="loginPwd" type="password" class="form-control" placeholder="password" value="thisis1APPLE">
                <span class="input-group-btn"><button class="btn btn-default" type="button" onclick="login()">登录</button></span>
            </div>
        </div>
        <div id="change" style="display: none;">
            <br>
            <div class="input-group">
                <span class="input-group-addon">新密码</span>
                <input id="changePwd" type="password" class="form-control" placeholder="password" onmouseenter="this.type='id'" onmouseleave="this.type='password'">
                <span class="input-group-btn"><button id="changeBtn" class="btn btn-default" type="button" onclick="change()">修改</button></span>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 box">
        <div class="page-header">
            <h3><span class="glyphicon glyphicon-stats"></span> 成绩</h3>
        </div>
        <div class="btn-group">
            <a id="scoreOld" class="btn btn-default e" target="_blank">原版</a>
            <a class="btn btn-default e" href="/score" target="_blank">新版</a>
        </div>
    </div>
</body>